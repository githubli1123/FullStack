图层残留问题

bug发生的条件：点击某一个按钮，触发事件：请求后端数据并加载图层到map中，这个请求数据的过程较长，在等待数据全部请求完成的过程中图层无法加载，但是这时却再次点击了按钮，触发事件：清除该图层，可无法找到这个图层（因为压根就没有加载这个图层），当数据请求完成后会继续去执行加载图层这个操作，从而导致按钮状态是图层未加载但图层却在地图上的情形。

角度一：

这个bug发生的原因是异步导致的数据（图层组）不一致问题。 “ 请求数据 ” 和 “ 载入图层 ” 这两个事件是以此发生，但 “ 载入图层 ” 事件需要等待 “ 请求数据 ” 事件的完成后再发生（ “ 载入图层 ” 事件有较长的数据影响真空期），可是 “ 取消载入图层 ” 在这个真空期中发生，误认为数据是我们预期的那样可以改变。

解决方法：在点击按钮就创建一个图层（空的）并给 “ 请求数据 ” 事件传递一个 id 来做到事件与数据的映射对应【表述不是很清晰】，再次点击时销毁这个图层（该图层消失，映射断开）。在请求完数据后再去改变图层数据，填补空图层，找不到就不填充。

角度二：

这个bug发生的原因在于事件之间的执行顺序问题。  “ 请求数据 ” 和 “ 载入图层 被默认放在一个线上，“ 取消载入图层 ” 放在另一条不相干的线上，但是这个两条线都会影响同一个数据（不只是修改，甚至包含了新增删除）。

![](E:\AProject\FunctionSet\09Q图层残留问题\img\md两线.png)

解决方法：重新组合事件的顺序和触发逻辑。

![](E:\AProject\FunctionSet\09Q图层残留问题\img\md一线.png)

但这里有一个细节就是：每次点击都会请求数据。这是不可取的，也需要再加一个状态 `isDataDownloaded` 来避免反复请求数据。



角度三：